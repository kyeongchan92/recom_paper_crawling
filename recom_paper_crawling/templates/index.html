{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interactive Citation Graph</title>
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>

<body>
  <!-- <button id="rearrange-btn">ì¬ì •ë ¬</button> -->

  <form id="upload-form" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="file" id="file-input" name="file">
    <button type="submit">ì—…ë¡œë“œ</button>
  </form>

  <button id="paper-parse-btn" style="display:none;">ë…¼ë¬¸ íŒŒì‹± ì‹œì‘</button>
  <pre id="parsed-output"></pre>
  <button id="ref-parse-btn" style="display:none;">Reference íŒŒì‹± ì‹œì‘</button>
  <pre id="parsed-output-ref"></pre>

  <div style="display: flex; height: 100vh;">
    <!-- ğŸ”¹ ì™¼ìª½ ì‚¬ì´ë“œë°” (ë…¼ë¬¸ ë¦¬ìŠ¤íŠ¸) -->
    <div id="paper-list-container">
      <h3>ğŸ“š Paper Nodes</h3>
      <ul id="paper-list" style="list-style: none; padding: 0;"></ul>
    </div>

    <!-- ğŸ”¹ ê¸°ì¡´ì˜ SVG ê·¸ë˜í”„ (ìš°ì¸¡) -->
    <div style="flex-grow: 1; display: flex; justify-content: center; align-items: center;">
      <svg id="graph-svg"></svg>
    </div>
  </div>


  <!-- Djangoì—ì„œ ì „ë‹¬í•œ JSON ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ -->
  <script id="papers-data" type="application/json">
    {{ papers_json|safe }}
  </script>

  <!-- <button class="button" onclick="sortByYearAndCitation()">Sort by Year</button> -->

  <!-- script.jsë¥¼ ê°€ì¥ ë§ˆì§€ë§‰ì— ì‹¤í–‰ -->
  <script defer src="{% static 'js/script.js' %}"></script>
</body>
<script>

  // document.getElementById("rearrange-btn").addEventListener("click", rearrangeNodes);

  document.getElementById("upload-form").addEventListener("submit", function (event) {
    event.preventDefault();  // ê¸°ë³¸ ì œì¶œ ë™ì‘ ë°©ì§€

    let formData = new FormData();
    let fileInput = document.getElementById("file-input");
    let paperParseButton = document.getElementById("paper-parse-btn");  // íŒŒì‹± ë²„íŠ¼ ì„ íƒ

    if (fileInput.files.length === 0) {
      alert("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”!");
      return;
    }

    formData.append("file", fileInput.files[0]);

    fetch("{% url 'file_upload' %}", {
      method: "POST",
      body: formData,
      headers: {
        "X-CSRFToken": "{{ csrf_token }}"
      }
    })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();  // âœ… JSON ì‘ë‹µì´ ì•„ë‹ ê²½ìš° ìë™ìœ¼ë¡œ ì—ëŸ¬ ë°œìƒ
      })
      .then(data => {
        if (data.success) {
          alert("íŒŒì¼ ì—…ë¡œë“œ ì„±ê³µ!\nì—…ë¡œë“œëœ íŒŒì¼: " + data.file_url);

          // âœ… "íŒŒì‹± ì‹œì‘" ë²„íŠ¼ ë³´ì´ê¸°
          paperParseButton.style.display = "block";

          // âœ… íŒŒì¼ IDë¥¼ ë²„íŠ¼ì— ì €ì¥í•˜ì—¬ ì´í›„ í´ë¦­ ì‹œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•¨
          paperParseButton.dataset.fileId = data.file_id;
        } else {
          alert("íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨! " + JSON.stringify(data.errors));
        }
      })
      .catch(error => {
        console.error("Error:", error);
      });
  });

  document.getElementById("paper-parse-btn").addEventListener("click", function () {
    let fileId = this.dataset.fileId;  // âœ… ì €ì¥ëœ file_id ê°€ì ¸ì˜¤ê¸°
    let RefParseButton = document.getElementById("ref-parse-btn");  // íŒŒì‹± ë²„íŠ¼ ì„ íƒ

    if (!fileId) {
      alert("íŒŒì¼ì„ ì—…ë¡œë“œí•œ í›„ íŒŒì‹±ì„ ì‹œì‘í•˜ì„¸ìš”!");
      return;
    }

    fetch(`/paper_parse/${fileId}/`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          document.getElementById("parsed-output").textContent = data.extracted_text;

          RefParseButton.style.display = "block";
          RefParseButton.dataset.fileId = data.file_id;

        } else {
          alert("íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨!");
        }
      })
      .catch(error => {
        console.error("Error:", error);
      });
  });

  document.getElementById("ref-parse-btn").addEventListener("click", async function () {
    console.log("Reference íŒŒì‹± ì‹œì‘ ë²„íŠ¼ ëˆŒë¦¼")
    let fileId = this.dataset.fileId;

    if (!fileId) {
      alert("íŒŒì¼ì„ ì—…ë¡œë“œí•œ í›„ íŒŒì‹±ì„ ì‹œì‘í•˜ì„¸ìš”!");
      return;
    }

    try {
      // ğŸ”¹ 1ï¸âƒ£ ë¨¼ì € ì†ŒìŠ¤ ë…¼ë¬¸(source_dict) ì¶”ê°€
      const sourceResponse = await fetch(`/source_parse/`);
      const sourceData = await sourceResponse.json();

      if (!sourceData.success) {
        alert("ì†ŒìŠ¤ ë…¼ë¬¸ ì¶”ê°€ ì‹¤íŒ¨!");
        return;
      }

      const sourceTitle = sourceData.source_dict.from_paper.title;
      console.log(`âœ… ì†ŒìŠ¤ ë…¼ë¬¸ ì¶”ê°€ ì™„ë£Œ: ${sourceTitle}`);

      const newPaper = {
        title: sourceData.source_dict.from_paper.title,
        citationCount: Math.floor(Math.random() * 50), // ì„ì‹œ citationCount (ì‹¤ì œ ë°ì´í„°ê°€ í•„ìš”í•¨)
        year: new Date().getFullYear()  // í˜„ì¬ ì—°ë„
      };
      console.log(`newPaper: ${newPaper}`);
      addNode(newPaper);  // ìƒˆ ë…¸ë“œ ì¶”ê°€

      // ğŸ”¹ 2ï¸âƒ£ ì°¸ì¡° ë…¼ë¬¸(ref_dict) ê°€ì ¸ì˜¤ê¸° (EventSource ì‚¬ìš©)
      console.log("âœ… EventSourceë¥¼ í†µí•´ ì°¸ì¡° ë…¼ë¬¸ ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘");

      if (window.eventSource) {
        window.eventSource.close();  // ê¸°ì¡´ ì—°ê²°ì´ ìˆìœ¼ë©´ ë‹«ê¸°
      }

      window.eventSource = new EventSource(`/reference_parse/`);

      window.eventSource.onmessage = function (event) {
        try {
          let data = JSON.parse(event.data);
          console.log("data", data)
          if (data.one_ref_info) {
            console.log("âœ… ìƒˆ ë…¼ë¬¸ ì¶”ê°€: ", data.one_ref_info);

            let paper = data.one_ref_info.from_paper;
            let citation = data.one_ref_info.from_scholarly?.citation_count?.value
              || data.one_ref_info.from_request?.citation_count?.value;

            let newPaper = {
              title: paper.title,
              citationCount: citation,
              year: paper.year
            };

            console.log("newPaper", newPaper)

            addNode(newPaper);  // ğŸ”¥ ì¦‰ì‹œ ê·¸ë˜í”„ì— ë°˜ì˜
          }
        } catch (error) {
          console.error("JSON íŒŒì‹± ì˜¤ë¥˜:", error);
        }
      };

      window.eventSource.onerror = function (event) {
        let errorMessage = "âŒ ì„œë²„ ì—°ê²° ì¢…ë£Œ";

        if (event.target.readyState === EventSource.CLOSED) {
          errorMessage += " (ì„œë²„ì—ì„œ ì—°ê²°ì„ ë‹«ìŒ)";
        } else if (event.target.readyState === EventSource.CONNECTING) {
          errorMessage += " (ë‹¤ì‹œ ì—°ê²°ì„ ì‹œë„ ì¤‘)";
        } else {
          errorMessage += ` (ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜)`;
        }

        console.error(errorMessage, event);

        window.eventSource.close();
      };

    } catch (error) {
      console.error("Error:", error);
    }
  });

  function addNode(newPaper) {
    let citationCount = newPaper.citationCount || 1;  // ê¸°ë³¸ê°’ ì„¤ì •


    let newNode = {
      id: newPaper.title,
      size: Math.max(10, Math.log(newPaper.citationCount + 1) * 10),
      citationCount: newPaper.citationCount,
      year: newPaper.year,
      x: (width - sidebarWidth) / 2 + Math.random() * 50 - 25,  // ì¤‘ì•™ì—ì„œ ì•½ê°„ì˜ ëœë¤ ì˜¤í”„ì…‹ ì¶”ê°€
      y: height / 2 + Math.random() * 50 - 25
    };

    console.log("newNode", newNode)

    nodes.push(newNode);

    let newCircle = svg.append("circle")
      .datum(newNode)
      .attr("r", radiusScale(newNode.citationCount) + 5)
      .attr("fill", "orange")
      .attr("stroke", "#333")
      .attr("stroke-width", 1.5)
      .on("mouseover", function (event, d) {
        d3.select(this).attr("fill", "#ff4500");
        title_texts
          .filter(textData => textData.id === d.id)
          .attr("opacity", "1");
      })
      .on("mouseout", function (event, d) {
        d3.select(this).attr("fill", "orange");
        title_texts
          .filter(textData => textData.id === d.id)
          .attr("opacity", "0.3");
      })
      .call(d3.drag()
        .on("start", dragStarted)
        .on("drag", dragged)
        .on("end", dragEnded)
      );

    let newTitle = svg.append("text")
      .datum(newNode)
      .classed("title-text", true)
      .text(newNode.id)
      .attr("dx", newNode.size / 10)
      .attr("opacity", "0.2");

    let newCitationText = svg.append("text")
      .datum(newNode)
      .classed("citation-text", true)
      .text(`${newNode.citationCount.toLocaleString()}`)
      .attr("fill", "white")
      .attr("font-size", Math.max(8, newNode.size / 3))
      .attr("text-anchor", "middle")
      .attr("dy", newNode.size / 20);

    // ğŸ”¹ ë…¼ë¬¸ ë¦¬ìŠ¤íŠ¸ UI ì—…ë°ì´íŠ¸
    updatePaperList(newNode);

    circle_tags = svg.selectAll("circle");
    title_texts = svg.selectAll(".title-text");
    citation_count_texts = svg.selectAll(".citation-text");

    simulation.nodes(nodes);
    simulation.alpha(0.5).restart();
  }

  function updatePaperList(newNode) {
    let paperList = document.getElementById("paper-list");

    // ê¸°ì¡´ì— ê°™ì€ ì œëª©ì´ ìˆëŠ”ì§€ í™•ì¸
    let existingItem = [...paperList.children].find(li => li.dataset.id === newNode.id);
    if (existingItem) return;  // ì¤‘ë³µ ë°©ì§€

    // ğŸ”¹ ìƒˆ ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ìƒì„±
    let listItem = document.createElement("li");
    listItem.dataset.id = newNode.id;
    listItem.style.padding = "5px";
    listItem.style.borderBottom = "1px solid #ddd";
    listItem.style.cursor = "pointer";

    listItem.innerHTML = `
        <strong>${newNode.id}</strong> <br>
        <small>ğŸ“† ${newNode.year} | ğŸ”— ${newNode.citationCount.toLocaleString()} citations</small>
    `;

    // í´ë¦­í•˜ë©´ í•´ë‹¹ ë…¸ë“œë¡œ í¬ì»¤ìŠ¤ ì´ë™
    listItem.addEventListener("click", () => {
      d3.selectAll("circle")
        .attr("stroke", "#333")
        .attr("stroke-width", 1.5);

      let selectedCircle = d3.selectAll("circle").filter(d => d.id === newNode.id);
      selectedCircle.attr("stroke", "red").attr("stroke-width", 3);
    });

    // ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
    paperList.appendChild(listItem);
  }

</script>

</html>